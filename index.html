<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§Ü‡§≠‡•Ç‡§∑‡§£ ‡§ó‡§ø‡§∞‡§µ‡•Ä - ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</title>
    <style>
        /* CSS (‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§®) */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h1 { text-align: center; color: #0056b3; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        fieldset { margin-bottom: 25px; border: 1px solid #007bff; padding: 20px; border-radius: 8px; }
        legend { font-weight: bold; color: #007bff; padding: 0 10px; font-size: 1.2em; }
        label { display: block; margin-bottom: 5px; margin-top: 10px; font-weight: 600; }
        input[type="text"], input[type="number"], input[type="tel"], textarea {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
        }
        input[type="file"] { margin-bottom: 15px; border: 1px dashed #aaa; padding: 10px; width: 100%; border-radius: 5px;}
        #signatureCanvas, #returnSignatureCanvas { border: 2px solid #333; background-color: #fff; cursor: crosshair; display: block; margin-top: 5px; }
        .btn { padding: 10px 15px; background-color: #5cb85c; color: white; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; margin-top: 10px; }
        .btn-clear { background-color: #f0ad4e; margin-left: 10px; }
        .btn-primary { background-color: #007bff; }
        .btn:hover { opacity: 0.9; }
        
        /* Tabs */
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; border-radius: 5px 5px 0 0; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #ccc; }
        .tabcontent { padding: 6px 12px; border: 1px solid #ccc; border-top: none; background-color: white; border-radius: 0 0 5px 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>‡§Ü‡§≠‡•Ç‡§∑‡§£ ‡§ó‡§ø‡§∞‡§µ‡•Ä - ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</h1>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'Issuance')">‡§®‡§Ø‡§æ ‡§ã‡§£ ‡§ú‡§æ‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
      <button class="tablinks" onclick="openTab(event, 'Return')">‡§ã‡§£ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç / ‡§µ‡§æ‡§™‡§∏‡•Ä</button>
    </div>

    <div id="Issuance" class="tabcontent">
        <h2>‡§®‡§Ø‡§æ ‡§ó‡§ø‡§∞‡§µ‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</h2>
        <form id="loanIssuanceForm">

            <fieldset>
                <legend>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£</legend>
                <label for="name">‡§®‡§æ‡§Æ:</label>
                <input type="text" id="name" name="name" required>

                <label for="mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (Loan ID):</label>
                <input type="tel" id="mobile" name="mobile" required>

                <label for="aadharId">‡§Ü‡§ß‡§æ‡§∞/‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ:</label>
                <input type="text" id="aadharId" name="aadharId" required>
                
                <label for="address">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡§§‡§æ:</label>
                <textarea id="address" name="address" rows="3" required></textarea>
            </fieldset>

            <fieldset>
                <legend>‡§ó‡§ø‡§∞‡§µ‡•Ä ‡§Ü‡§≠‡•Ç‡§∑‡§£ ‡§î‡§∞ ‡§ã‡§£ ‡§µ‡§ø‡§µ‡§∞‡§£</legend>
                <label for="goldWeight">‡§∏‡•ã‡§®‡•á ‡§ï‡§æ ‡§µ‡§ú‡§® (‡§ó‡•ç‡§∞‡§æ‡§Æ):</label>
                <input type="number" id="goldWeight" name="goldWeight" step="0.01" required>

                <label for="jewelryDesc">‡§µ‡§ø‡§µ‡§∞‡§£ (‡§ö‡•á‡§®, ‡§ö‡•Ç‡§°‡§º‡•Ä ‡§Ü‡§¶‡§ø):</label>
                <textarea id="jewelryDesc" name="jewelryDesc" rows="2" required></textarea>
                
                <label for="loanAmount">‡§ã‡§£ ‡§∞‡§æ‡§∂‡§ø (‚Çπ):</label>
                <input type="number" id="loanAmount" name="loanAmount" required>

                <label for="interestRate">‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞ (% ‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡§æ‡§π):</label>
                <input type="number" id="interestRate" name="interestRate" step="0.1" required>

                <label for="loanDuration">‡§ã‡§£ ‡§Ö‡§µ‡§ß‡§ø (‡§Æ‡§π‡•Ä‡§®‡•á):</label>
                <input type="number" id="loanDuration" name="loanDuration" required>
                
                <p>‡§∏‡§Æ‡§ù‡•å‡§§‡•á ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ: <span id="agreementDate"></span></p>
            </fieldset>
            
            <fieldset>
                <legend>‡§´‡•ã‡§ü‡•ã ‡§î‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞</legend>
                
                <p>üí° **‡§´‡•ã‡§ü‡•ã ‡§∏‡•Ç‡§ö‡§®‡§æ:** ‡§∏‡§∞‡§≤‡§§‡§Æ ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£, ‡§´‡§º‡•ã‡§ü‡•ã ‡§∏‡•Ä‡§ß‡•á ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§Ç‡§ó‡•Ä‡•§ ‡§Ü‡§™‡§ï‡•ã ‡§´‡§º‡•ã‡§ü‡•ã ‡§≤‡•á‡§ï‡§∞ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ ‡§™‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§ï‡•á ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•ã ‡§∂‡•Ä‡§ü ‡§Æ‡•á‡§Ç ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§°‡§æ‡§≤‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§</p>

                <p><strong>1. ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•Ä ‡§≤‡§æ‡§á‡§µ ‡§´‡•ã‡§ü‡•ã:</strong></p>
                <input type="file" id="customerPhoto" accept="image/*" required>
                
                <p><strong>2. ‡§Ü‡§ß‡§æ‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã:</strong></p>
                <input type="file" id="aadharPhoto" accept="image/*" required>
                
                <p><strong>3. ‡§ó‡§ø‡§∞‡§µ‡•Ä ‡§Ü‡§≠‡•Ç‡§∑‡§£ ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã:</strong></p>
                <input type="file" id="jewelryPhoto" accept="image/*" required>
                
                <p><strong>4. ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ (‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ):</strong></p>
                <canvas id="signatureCanvas" width="300" height="100"></canvas>
                <button type="button" class="btn btn-clear" onclick="clearSignature('signatureCanvas')">‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç</button>
                <br>
                
                <label style="margin-top: 15px;">
                    <input type="checkbox" id="termsAccepted" required>
                    ‡§Æ‡•à‡§Ç ‡§∏‡§≠‡•Ä **‡§ó‡•à‡§∞-‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï** ‡§∂‡§∞‡•ç‡§§‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•Ç‡§Å‡•§
                </label>
                
            </fieldset>

            <button type="submit" class="btn btn-primary">‡§ã‡§£ ‡§ú‡§æ‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>

        </form>
    </div>

    <div id="Return" class="tabcontent hidden">
        <h2>‡§ã‡§£ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</h2>
        <fieldset>
            <legend>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç</legend>
            <label for="searchId">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ID / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç:</label>
            <input type="text" id="searchId" placeholder="‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (Loan ID)" required>
            <button type="button" class="btn" onclick="searchLoanRecord()">‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ñ‡•ã‡§ú‡•á‡§Ç (Dummy)</button>
        </fieldset>

        <div id="loanDetailsDisplay" class="hidden">
            <h3 style="color: #009688;">‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Æ‡§ø‡§≤‡§æ! (‡§®‡§æ‡§Æ: <span id="customerNameDisplay"></span>)</h3>
            <p><strong>‡§ã‡§£ ID (‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤):</strong> <span id="loanIDDisplay"></span></p>
            <p><strong>‡§ã‡§£ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ<span id="loanAmountDisplay"></span></p>
            <p><strong>‡§Ü‡§≠‡•Ç‡§∑‡§£:</strong> <span id="jewelryDescDisplay_Return"></span></p>
            
            <form id="loanClosureForm">
                <fieldset>
                    <legend>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§µ‡§æ‡§™‡§∏‡•Ä ‡§î‡§∞ ‡§Ö‡§≠‡§ø‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø</legend>

                    <label for="closeDate">‡§∏‡§Æ‡§æ‡§™‡§® ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
                    <input type="text" id="closeDate" readonly>

                    <label for="totalPaidAmount">‡§ö‡•Å‡§ï‡§æ‡§à ‡§ó‡§à ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø (‡§Æ‡•Ç‡§≤‡§ß‡§® + ‡§¨‡•ç‡§Ø‡§æ‡§ú):</label>
                    <input type="number" id="totalPaidAmount" required>

                    <label for="returnNote">‡§ó‡§ø‡§∞‡§µ‡•Ä‡§ß‡§æ‡§∞‡•Ä ‡§ï‡§æ ‡§®‡•ã‡§ü (‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§ö‡•Å‡§ï‡§§‡§æ):</label>
                    <textarea id="returnNote" rows="3" required placeholder="‡§ú‡•à‡§∏‡•á: '‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§ö‡•Å‡§ï‡§§‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ, ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§∏‡§Ç‡§§‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§µ‡§æ‡§™‡§∏ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§'"></textarea>
                    
                    <p><strong>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§µ‡§æ‡§™‡§∏‡•Ä ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ (‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ):</strong></p>
                    <canvas id="returnSignatureCanvas" width="300" height="100"></canvas>
                    <button type="button" class="btn btn-clear" onclick="clearSignature('returnSignatureCanvas')">‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç</button>
                    
                    <button type="submit" class="btn btn-primary">‡§ã‡§£ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                </fieldset>
            </form>
        </div>
    </div>
</div>

<script>
    // *************************************************************
    // *************************************************************
    // ** ‡§Ö‡§§‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï: ‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏ ‡§≤‡§æ‡§á‡§® ‡§ï‡•ã ‡§Ö‡§™‡§®‡•á Apps Script Deployment URL ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç **
    // ** ‡§Ø‡§π URL 'https://script.google.com/macros/s/...' ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à **
    // *************************************************************
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwrgxw-peVF0XH4tExnN2eZINDLG8KnVZL8SE2uzgBYEDNYuIeXqWtsBt3uNZAbukhng/exec'; 
    // *************************************************************

    // --- General Functions ---
    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.add("hidden");
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).classList.remove("hidden");
        evt.currentTarget.className += " active";
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('agreementDate').textContent = new Date().toLocaleDateString('hi-IN');
        document.getElementById('closeDate').value = new Date().toLocaleDateString('hi-IN');
        document.querySelector(".tablinks").click(); // Default tab open
        
        setupSignaturePad('signatureCanvas');
        setupSignaturePad('returnSignatureCanvas');
    });

    // Signature Pad Functionality
    function setupSignaturePad(canvasId) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        ctx.strokeStyle = '#000000'; ctx.lineWidth = 2; ctx.lineCap = 'round';

        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const coords = getCoords(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const coords = getCoords(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();
        }
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
    }

    window.clearSignature = function(canvasId) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    // ----------------------------------------------------
    // --- Data Submission Functions (Linking to GAS) ---
    // ----------------------------------------------------

    // 1. Issuance Form Submission
    document.getElementById('loanIssuanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (APPS_SCRIPT_URL === 'YOUR_WEB_APP_URL_HERE') {
            alert('‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§ï‡•É‡§™‡§Ø‡§æ APPS_SCRIPT_URL ‡§ï‡•ã ‡§Ö‡§™‡§®‡•á ‡§°‡§ø‡§™‡•ç‡§≤‡•â‡§Ø‡§Æ‡•á‡§Ç‡§ü URL ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç‡•§');
            return;
        }

        const data = {
            sheet: 'Issuance_Data', // ‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§∂‡•Ä‡§ü
            // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§∏‡•á ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§≤‡•á‡§®‡§æ
            name: document.getElementById('name').value,
            mobile: document.getElementById('mobile').value,
            aadharId: document.getElementById('aadharId').value,
            address: document.getElementById('address').value,
            goldWeight: document.getElementById('goldWeight').value,
            jewelryDesc: document.getElementById('jewelryDesc').value,
            loanAmount: document.getElementById('loanAmount').value,
            interestRate: document.getElementById('interestRate').value,
            loanDuration: document.getElementById('loanDuration').value,
            signatureData: document.getElementById('signatureCanvas').toDataURL('image/png') // ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§°‡•á‡§ü‡§æ
        };
        
        // AJAX ‡§ï‡•â‡§≤: Apps Script ‡§ï‡•ã ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú‡§®‡§æ
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data)
            // ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§¶‡§≤‡§æ‡§µ: 'Content-Type': 'application/json' ‡§π‡•á‡§°‡§∞ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
        })
        .then(response => {
             // Apps Script response ‡§ï‡•ã ‡§π‡•à‡§Ç‡§°‡§≤ ‡§ï‡§∞‡§®‡§æ (‡§Ø‡§π ‡§π‡§Æ‡•á‡§∂‡§æ ‡§è‡§ï JSON response ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§§‡§æ ‡§π‡•à)
             // ‡§á‡§∏‡§≤‡§ø‡§è ‡§π‡§Æ ‡§™‡§π‡§≤‡•á response.text() ‡§™‡§∞ ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ‡§´‡§ø‡§∞ JSON ‡§ï‡•ã ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç
             return response.text(); 
        })
        .then(text => {
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                // ‡§Ø‡§¶‡§ø Apps Script ‡§®‡•á ‡§∏‡§æ‡§¶‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≠‡•á‡§ú‡§æ
                result = { success: false, error: 'Non-JSON response received. Check Apps Script logs.' };
            }

            if (result.success) {
                alert('‚úÖ ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï Google Sheet ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§î‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ Drive ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§');
                e.target.reset();
                clearSignature('signatureCanvas');
            } else {
                alert('‚ùå ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à: ' + result.error);
                console.error('Submission Error:', result.error);
            }
        })
        .catch(error => {
            alert('‚ùå ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§Ø‡§æ‡•§');
            console.error('Network Error:', error);
        });
    });

    // 2. Return Form Search (Dummy Function for UX)
    window.searchLoanRecord = function() {
        const searchId = document.getElementById('searchId').value;
        if (searchId) {
            // ‡§Ø‡§π ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§è‡§ï ‡§¶‡§ø‡§ñ‡§æ‡§µ‡§ü‡•Ä ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§π‡•à‡•§ ‡§Ö‡§∏‡§≤‡•Ä ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§ï‡•ã‡§° ‡§ö‡§æ‡§π‡§ø‡§è‡•§
            const dummyRecord = { name: "‡§∞‡§Æ‡•á‡§∂ ‡§ï‡•Å‡§Æ‡§æ‡§∞", amount: 50000, jewelry: "1 ‡§∏‡•ã‡§®‡•á ‡§ï‡•Ä ‡§ö‡•á‡§®, 20 ‡§ó‡•ç‡§∞‡§æ‡§Æ" };
            
            document.getElementById('customerNameDisplay').textContent = dummyRecord.name;
            document.getElementById('loanIDDisplay').textContent = searchId;
            document.getElementById('loanAmountDisplay').textContent = dummyRecord.amount;
            document.getElementById('jewelryDescDisplay_Return').textContent = dummyRecord.jewelry;
            document.getElementById('loanDetailsDisplay').classList.remove('hidden');
        } else {
            alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§');
            document.getElementById('loanDetailsDisplay').classList.add('hidden');
        }
    }

    // 3. Loan Closure Form Submission
    document.getElementById('loanClosureForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (APPS_SCRIPT_URL === 'YOUR_WEB_APP_URL_HERE') {
            alert('‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§ï‡•É‡§™‡§Ø‡§æ APPS_SCRIPT_URL ‡§ï‡•ã ‡§Ö‡§™‡§®‡•á ‡§°‡§ø‡§™‡•ç‡§≤‡•â‡§Ø‡§Æ‡•á‡§Ç‡§ü URL ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç‡•§');
            return;
        }

        const data = {
            sheet: 'Return_Data', // ‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§∂‡•Ä‡§ü
            searchId: document.getElementById('searchId').value, // Loan ID
            totalPaidAmount: document.getElementById('totalPaidAmount').value,
            returnNote: document.getElementById('returnNote').value,
            returnSignatureData: document.getElementById('returnSignatureCanvas').toDataURL('image/png')
        };

        // AJAX ‡§ï‡•â‡§≤: Apps Script ‡§ï‡•ã ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú‡§®‡§æ
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data)
             // ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§¶‡§≤‡§æ‡§µ: 'Content-Type': 'application/json' ‡§π‡•á‡§°‡§∞ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
        })
        .then(response => {
            return response.text(); 
        })
        .then(text => {
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                result = { success: false, error: 'Non-JSON response received. Check Apps Script logs.' };
            }
            
            if (result.success) {
                alert('‚úÖ ‡§ã‡§£ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§Ç‡§¶ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§µ‡§æ‡§™‡§∏‡•Ä ‡§ï‡§æ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ Drive ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§');
                document.getElementById('loanDetailsDisplay').classList.add('hidden');
                document.getElementById('loanClosureForm').reset();
                clearSignature('returnSignatureCanvas');
            } else {
                alert('‚ùå ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à: ' + result.error);
                console.error('Submission Error:', result.error);
            }
        })
        .catch(error => {
            alert('‚ùå ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§Ø‡§æ‡•§');
            console.error('Network Error:', error);
        });
    });

</script>
</body>
</html>
